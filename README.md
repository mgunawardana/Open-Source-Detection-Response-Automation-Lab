
# *SOC Automation Lab — Wazuh → Sysmon → Custom Rules → Shuffle SOAR → VirusTotal → TheHive → Email*

## **Objective**

This project focused on deploying a full open source SOC detection and automation pipeline using Wazuh (SIEM/EDR), Sysmon (endpoint telemetry), Shuffle SOAR (automation engine), VirusTotal (Threat Intel), and TheHive (Case Management).

The goal was to:

* Deploy a multi-VM security stack on GCP
* Collect Windows Sysmon logs through Wazuh
* Create custom detection rules (Mimikatz)
* Automate alert forwarding to Shuffle SOAR
* Enrich alerts via VirusTotal
* Generate automated case creation in TheHive
* Send email notifications for analyst visibility

This project replicates a realistic SOC workflow where detection, enrichment, and case management are largely automated — reducing analyst workload and accelerating response.

---

## **Skills Learned**

* Cloud deployment and network design (GCP VPC, firewall rules, public/private access).
* Endpoint telemetry through **Sysmon** with advanced configurations.
* Wazuh management: agent deployment, custom rules, log configuration, archives indexing.
* Creating and tuning SIEM detections (custom rule for Mimikatz).
* SOAR engineering through **Shuffle**: webhook ingestion, regex parsing, enrichment flows.
* OSINT enrichment with **VirusTotal API**.
* Automating case creation in **TheHive**.
* End-to-end SOC response workflow integration.
* Testing detections using real attacker tooling (Mimikatz execution).

---

## **Tools Used**

### **SIEM / EDR — Wazuh**

Used for:

* Endpoint agent deployment
* Log ingestion
* Sysmon telemetry parsing
* Custom rule creation
* Alert generation
* Forwarding alerts to SOAR

**Why this category fits:**
Wazuh acts as the detection engine, similar to a SIEM+EDR hybrid, capable of rules-based detection.

---

### **Endpoint Telemetry — Sysmon**

Installed on Windows 10 with Olaf’s hardened configuration to produce clean, high-fidelity logs.

**Why this category fits:**
Sysmon provides deep process, network, and image load visibility — essential for detecting attacker tools.

---

### **SOAR Platform — Shuffle**

Used to:

* Accept Wazuh alerts via webhook
* Parse fields using Regex Capture Group
* Query VirusTotal for hash reputation
* Create cases in TheHive
* Trigger email notifications

**Why this category fits:**
Shuffle automates analysis and pushes enriched data to multiple destinations.

---

### **Threat Intelligence — VirusTotal API**

Used for:

* Hash lookups
* Malware reputation
* Context enrichment

---

### **Case Management — TheHive**

Used to:

* Store automated incident reports
* Manage alerts generated by Shuffle

---

### **Cloud Provider — Google Cloud Platform (GCP)**

Hosted:

* Wazuh server
* TheHive server
* Shuffle SOAR server

---

## **Deployment Steps**
---

# **1. Wazuh Deployment**

Installed Wazuh on its dedicated Ubuntu server, then accessed it via:

```
https://<wazuh_public_ip>
```

---
![Wazuh Dashboard Login](https://github.com/mihindigunawardana/soc-automation-part-2/blob/main/Wazuh%20Dashboard%20Login.png)

---

# **2. Sysmon Deployment on Windows 10**

Installed **Sysmon** with Olaf’s Sysmon config:

```
.\sysmon64.exe -i .\sysmonconfig.xml
```

Verified Sysmon is running in Event Viewer.

---
![Sysmon Installation](https://github.com/mihindigunawardana/soc-automation-part-2/blob/main/Sysmon%20Installation.png)

---
![Sysmon Running](https://github.com/mihindigunawardana/soc-automation-part-2/blob/main/Sysmon%20Running%20.png)

---

# **3. Deploying Wazuh Agent on Windows**

Accessed Wazuh Dashboard → Agents → Deployed an agent to Windows 10.

Then edited:

```
C:\Program Files (x86)\ossec-agent\ossec.conf
```

Added Sysmon log path so Wazuh captures Sysmon EventChannel logs.

Restarted the Wazuh agent service.

Checked Sysmon logs appear in Wazuh by searching:

---
![Agent Active Status](https://github.com/mihindigunawardana/soc-automation-part-2/blob/main/Wazuh%20Agent%20Active.png)

---
![Ossec.conf File Configuration](https://github.com/mihindigunawardana/soc-automation-part-2/blob/main/Ossec.conf%20file%20Configuration.png)

---
![Wazuh Capturing Sysmon Logs](https://github.com/mihindigunawardana/soc-automation-part-2/blob/main/Wazuh%20Capturing%20Sysmon%20Logs.png)

---

# **4. Wazuh Configuration Adjustments**

Backed up ossec.conf:

```bash
cp /var/ossec/etc/ossec.conf ~/backup_ossec.conf
```

Modified ossec.conf:

* Enabled logall = yes
* Enabled logall_json = yes

Restarted Wazuh Manager.

Enabled archives index:

```
sudo nano /etc/filebeat/filebeat.yml
archives:
  enabled: true
```

Restarted Filebeat.

Now Wazuh Dashboard displays:

**Index:** `wazuh-archives-*`

---

### **Screenshots to include:**

✔ archives index visible in Wazuh
✔ ossec.conf configuration changes

---

# **7. Testing Detection — Running Mimikatz**

Copied mimikatz.exe to Windows.
Executed to generate Sysmon logs.

Initially → **No Mimikatz logs under alerts**, only visible under archives.

Created index:

```
wazuh-archives-*
```

Re-ran Mimikatz → logs visible.

---

### **Screenshots to include:**

✔ Mimikatz execution
✔ Logs appearing under wazuh-archives-*

---

# **8. Creating a Custom Wazuh Rule**

Added the following custom detection rule:

```xml
<rule id="100002" level="15">
  <if_group>sysmon_event1</if_group>
  <field name="win.eventdata.originalFileName" type="pcre2">(?)mimikatz\.exe</field>
  <description>Mimikatz Usage Detected.</description>
  <mitre>
    <id>T1003</id>
  </mitre>
</rule>
```

Restarted Wazuh.

Re-ran Mimikatz → alert appeared under `wazuh-alerts`.

Rule triggered successfully.

---

### **Screenshots to include:**

✔ Custom rule XML
✔ Wazuh alert showing rule ID + description
✔ MITRE mapping visible

---

# **9. Shuffle SOAR Integration**

Accessed Shuffle via:

```
http://<shuffle_ip>:3001
```

Created a Webhook Trigger Node.

Copied webhook URL.

Added the webhook URL to Wazuh’s ossec.conf inside `<integration>` block.

Restarted Wazuh Manager.

Triggered Mimikatz again → alert arrived in Shuffle.

---

### **Screenshots to include:**

✔ Shuffle Workflow Canvas
✔ Webhook Node
✔ Alert arriving in Shuffle

---

# **10. SOAR Enrichment Workflow**

### Workflow Steps:

1. **Webhook Trigger** (receives Wazuh alert)
2. **Regex Capture Group Node**

   * Extracts the file hash
3. **VirusTotal Node**

   * Performs hash reputation lookup
4. **TheHive Node**

   * Creates a case with enrichment details
5. **Email Notification Node**

   * Sends alert summary & VT results to analyst inbox

---

### **Screenshots to include:**

✔ Regex Capture Node config
✔ VirusTotal API response
✔ TheHive case created automatically
✔ Email screenshot showing alert details

---

# **11. TheHive Configuration**

Accessed TheHive at:

```
http://<thehive_ip>:9000
```

Setup:

* Organization created
* Two analyst users added
* API key generated
* Connected Shuffle → TheHive using API key

Cases are created automatically by the workflow.

---

### **Screenshots to include:**

✔ TheHive Login Page
✔ Organization view
✔ Case details created from Shuffle

---

# **12. Validation Test**

Ran Mimikatz on Windows again.

Pipeline:

* Sysmon logged event
* Wazuh captured + triggered custom rule
* Wazuh forwarded alert to Shuffle
* Shuffle extracted hash
* VirusTotal enriched data
* TheHive case created
* Email sent with alert + enrichment

Full workflow executed exactly as designed.

---

### **Screenshots to include:**

✔ Wazuh alert
✔ Shuffle execution log
✔ VirusTotal enrichment
✔ TheHive case entry
✔ Email received

---

# **Threat Context**

This project simulated **Credential Dumping** via Mimikatz — a common attacker technique after initial compromise for privilege escalation.

### **MITRE ATT&CK Mapping**

* **TA0006 – Credential Access**
* **T1003 – OS Credential Dumping**
* **T1059 – (If PowerShell execution observed)**

---

# **OSINT / Enrichment Considerations**

VirusTotal provided:

* Hash reputation
* Detection counts
* File metadata
* Sandbox results

Future enrichment options:

* Hybrid-Analysis
* Intezer
* Joe Sandbox
* WHOIS / ASN lookups
* AbuseIPDB

---

# **Pyramid of Pain Relevance**

This detection targets **behavior (credential dumping)** — not weak indicators.

Behavior is harder for attackers to modify, meaning this is a high-value detection.

---

# **Reflection / Takeaways**

* Built a full **Wazuh → SOAR → TI → Case Management** workflow.
* Learned endpoint telemetry via Sysmon and how to integrate it with Wazuh.
* Created a high-confidence custom rule for Mimikatz execution.
* Automated enrichment with VirusTotal.
* Automated case creation in TheHive.
* Sent out automated email notifications for analyst visibility.
* Validated everything using real attacker tooling — not theory.

---


